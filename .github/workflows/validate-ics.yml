name: Validate ICS files

on:
  push:
    paths:
      - "calendars/**/*.ics"
      - ".github/workflows/validate-ics.yml"
  pull_request:
    paths:
      - "calendars/**/*.ics"
      - ".github/workflows/validate-ics.yml"

jobs:
  validate-ics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install icalendar

      - name: Validate ICS files
        shell: python
        run: |
          import os
          import sys
          from icalendar import Calendar

          root = "calendars"
          if not os.path.isdir(root):
            print(f"No '{root}' directory found. Skipping.")
            sys.exit(0)

          failed = False

          for dirpath, _, filenames in os.walk(root):
            for filename in filenames:
              if not filename.lower().endswith(".ics"):
                continue
              path = os.path.join(dirpath, filename)
              print(f"Validating: {path}")
              try:
                with open(path, "rb") as f:
                  data = f.read()
                Calendar.from_ical(data)
              except Exception as e:
                failed = True
                print(f"::error file={path}::Invalid ICS: {e}")

          if failed:
            sys.exit(1)
          print("All ICS files are valid âœ…")
